name: Build and Deploy to DigitalOcean

on:
  push:
    tags:
      - "infra"

jobs:
  # make the build an sepperate action that looks at the tag
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to DigitalOcean Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.DOCR_REGISTRY }}
          username: ${{ secrets.DOCR_USERNAME }}
          password: ${{ secrets.DOCR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build & Push Laravel app image
      - name: Build and Push Laravel Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dockerfile
          push: true
          tags: |
            ${{ secrets.DOCR_REGISTRY }}/statamic-app:${{ github.ref_name }}
            ${{ secrets.DOCR_REGISTRY }}/statamic-app:latest

  # Build & Push MinIO custom image
  # - name: Build and Push MinIO Image
  #   uses: docker/build-push-action@v5
  #   with:
  #     context: .
  #     file: ./docker/dockerfile.minio
  #     push: true
  #     tags: |
  #       ${{ secrets.DOCR_REGISTRY }}/statamic-minio:${{ github.ref_name }}
  #       ${{ secrets.DOCR_REGISTRY }}/statamic-minio:latest

  # make terraform a seperate action with if statment that looks at the tag
  # Provision infrastructure with Terraform
  terraform:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate app.yaml
        run: |
          cat <<EOF > app.yaml
          name: statamic-app
          region: ${{ secrets.REGION }}
          services:
            - name: web
              image:
                registry_type: DOCR
                repository: ${{ secrets.DOCR_REPOSITORY }}
                tag: latest
              http_port: 80
              instance_size_slug: basic-xxs
              instance_count: 1
              envs:
                - key: APP_ENV
                  value: "${{ secrets.APP_ENV }}"
                - key: APP_KEY
                  scope: RUN_AND_BUILD_TIME
                  value: "${{ secrets.APP_KEY }}"
                - key: DB_HOST
                  value: "${{ secrets.DB_HOST }}"
                - key: DB_DATABASE
                  value: "${{ secrets.DB_DATABASE }}"
                - key: DB_USERNAME
                  value: "${{ secrets.DB_USERNAME }}"
                - key: DB_PASSWORD
                  value: "${{ secrets.DB_PASSWORD }}"
                - key: APP_DEBUG
                  value: "${{ secrets.APP_DEBUG }}"
                - key: LOG_LEVEL
                  value: "${{ secrets.LOG_LEVEL }}"
          EOF

      - name: Print app.yaml contents
        run: cat app.yaml

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init & Apply with remote backend
        env:
          TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
          TF_STATE_ENDPOINT: ${{ secrets.TF_STATE_ENDPOINT }}
          TF_STATE_REGION: ${{ secrets.TF_STATE_REGION }}
          DO_SPACES_KEY: ${{ secrets.SPACES_KEY }}
          DO_SPACES_SECRET: ${{ secrets.SPACES_SECRET }}
        run: |
          cd infra
          # Initialize Terraform with backend-config from secrets so state is persisted in Spaces
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=ci-cd-test-statamic/terraform.tfstate" \
            -backend-config="region=${TF_STATE_REGION}" \
            -backend-config="endpoint=${TF_STATE_ENDPOINT}" \
            -backend-config="access_key=${DO_SPACES_KEY}" \
            -backend-config="secret_key=${DO_SPACES_SECRET}" \
            -backend-config="skip_credentials_validation=true" \
            -backend-config="skip_metadata_api_check=true" \
            -backend-config="force_path_style=true"

          terraform apply -auto-approve \
            -var "do_token=${{ secrets.DO_TOKEN }}" \
            -var "app_key=${{ secrets.APP_KEY }}" \
            -var "app_image=${{ secrets.DOCR_REGISTRY }}/statamic-app:latest" \
            -var "db_password=${{ secrets.DB_PASSWORD }}" \
            -var "region=${{ secrets.REGION }}" \
            -var "redis_password=${{ secrets.REDIS_PASSWORD }}" \
            -var "spaces_key=${{ secrets.SPACES_KEY }}" \
            -var "app_repository=${{ secrets.DOCR_REPOSITORY }}" \
            -var "db_connection=${{ secrets.DB_CONNECTION }}" \
            -var "db_host=${{ secrets.DB_HOST }}" \
            -var "db_port=${{ secrets.DB_PORT }}" \
            -var "db_name=${{ secrets.DB_DATABASE }}" \
            -var "db_user=${{ secrets.DB_USERNAME }}" \
            -var "app_debug=${{ vars.APP_DEBUG }}" \
            -var "spaces_secret=${{ secrets.SPACES_SECRET }}" | tee terraform.log

          # Export outputs as JSON and upload for later jobs
          terraform output -json > tf_outputs.json
          # move outputs to top-level so other jobs can pick them up as an artifact
          mv tf_outputs.json ..

      - name: Upload Terraform outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: tf_outputs.json

      # - name: Upload Terraform log
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: terraform-log
      #     path: infra/terraform.log
