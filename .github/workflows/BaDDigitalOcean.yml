name: Build and Deploy to DigitalOcean

on:
  push:
    tags:
      - "v*"

jobs:
  # build:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Log in to DigitalOcean Container Registry
  #       uses: docker/login-action@v2
  #       with:
  #         registry: ${{ secrets.DOCR_REGISTRY }}
  #         username: ${{ secrets.DOCR_USERNAME }}
  #         password: ${{ secrets.DOCR_PASSWORD }}

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     # Build & Push Laravel app image
  #     - name: Build and Push Laravel Image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: .
  #         file: ./dockerfile
  #         push: true
  #         tags: |
  #           ${{ secrets.DOCR_REGISTRY }}/statamic-app:${{ github.ref_name }}
  #           ${{ secrets.DOCR_REGISTRY }}/statamic-app:latest

  # Build & Push MinIO custom image
  # - name: Build and Push MinIO Image
  #   uses: docker/build-push-action@v5
  #   with:
  #     context: .
  #     file: ./docker/dockerfile.minio
  #     push: true
  #     tags: |
  #       ${{ secrets.DOCR_REGISTRY }}/statamic-minio:${{ github.ref_name }}
  #       ${{ secrets.DOCR_REGISTRY }}/statamic-minio:latest

  # Provision infrastructure with Terraform
  terraform:
    runs-on: ubuntu-latest
    # needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate app.yaml
        run: |
          cat <<EOF > app.yaml
          name: statamic-app
          region: ${{ secrets.REGION }}
          services:
            - name: web
              image:
                registry_type: DOCR
                repository: ${{ secrets.DOCR_REPOSITORY }}
                tag: latest
              http_port: 8080
              instance_size_slug: basic-xxs
              instance_count: 1
              envs:
                - key: APP_ENV
                  value: "${{ secrets.APP_ENV }}"
                - key: APP_KEY
                  scope: RUN_AND_BUILD_TIME
                  value: "${{ secrets.APP_KEY }}"
                - key: DB_HOST
                  value: "${{ secrets.DB_HOST }}"
                - key: DB_DATABASE
                  value: "${{ secrets.DB_DATABASE }}"
                - key: DB_USERNAME
                  value: "${{ secrets.DB_USERNAME }}"
                - key: DB_PASSWORD
                  value: "${{ secrets.DB_PASSWORD }}"
                - key: APP_DEBUG
                  value: "${{ secrets.APP_DEBUG }}"
                - key: LOG_LEVEL
                  value: "${{ secrets.LOG_LEVEL }}"
          EOF

      - name: Print app.yaml contents
        run: cat app.yaml

      - name: Upload app.yaml artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-spec
          path: app.yaml

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init & Apply with live debug
        run: |
          cd infra
          export TF_LOG=DEBUG
          # Don't set TF_LOG_PATH to avoid conflict with tee
          terraform init
          terraform apply -auto-approve \
            -var "do_token=${{ secrets.DO_TOKEN }}" \
            -var "app_key=${{ secrets.APP_KEY }}" \
            -var "app_image=${{ secrets.DOCR_REGISTRY }}/statamic-app:latest" \
            -var "db_password=${{ secrets.DB_PASSWORD }}" \
            -var "region=${{ secrets.REGION }}" \
            -var "redis_password=${{ secrets.REDIS_PASSWORD }}" \
            -var "spaces_key=${{ secrets.SPACES_KEY }}" \
            -var "app_repository=${{ secrets.DOCR_REPOSITORY }}" \
            -var "db_connection=${{ secrets.DB_CONNECTION }}" \
            -var "db_host=${{ secrets.DB_HOST }}" \
            -var "db_port=${{ secrets.DB_PORT }}" \
            -var "db_name=${{ secrets.DB_DATABASE }}" \
            -var "db_user=${{ secrets.DB_USERNAME }}" \
            -var "app_debug=${{ vars.APP_DEBUG }}" \
            -var "spaces_secret=${{ secrets.SPACES_SECRET }}" | tee terraform.log
          # Save the app_url output for the next job
          terraform output -raw app_url > ../app_url.txt

      # - name: Upload Terraform log
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: terraform-log
      #     path: infra/terraform.log

      - name: Upload app_url output
        uses: actions/upload-artifact@v4
        with:
          name: app-url
          path: app_url.txt

  set-app-url-and-redeploy:
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Download app_url output
        uses: actions/download-artifact@v4
        with:
          name: app-url

      - name: Read assigned domain
        id: get_domain
        run: |
          DOMAIN=$(cat app_url.txt)
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV

      - name: Patch APP_URL to https
        run: |
          APP_URL="https://$DOMAIN"
          echo "APP_URL=$APP_URL" >> $GITHUB_ENV

      - name: Redeploy app with new APP_URL
        run: |
          # Update app.yaml with new APP_URL
          sed -i.bak "/key: APP_URL/!b;n;c\\                  value: \"$APP_URL\"" app.yaml
          cat app.yaml
          # Re-apply Terraform to redeploy
          cd infra
          terraform apply -auto-approve -var "app_url=$APP_URL"
