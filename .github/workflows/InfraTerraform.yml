name: Deploy infra to DigitalOcean

on:
  push:
    tags:
      - "infra"

jobs:

  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # - name: Set Terraform environment variables
      #   run: |
      #     export TF_VAR_do_token="${{ secrets.DO_TOKEN }}"
      #     export TF_VAR_app_key="${{ secrets.APP_KEY }}"
      #     export TF_VAR_app_image="${{ secrets.DOCR_REGISTRY }}/statamic-app:latest"
      #     export TF_VAR_db_password="${{ secrets.DB_PASSWORD }}"
      #     export TF_VAR_redis_password="${{ secrets.REDIS_PASSWORD }}"
      #   shell: bash

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init & Apply with live debug
        run: |
          cd infra
          export TF_LOG=DEBUG
          # Don't set TF_LOG_PATH to avoid conflict with tee
          terraform init
          terraform apply -auto-approve \
            -var "do_token=${{ secrets.DO_TOKEN }}" \
            -var "app_key=${{ secrets.APP_KEY }}" \
            -var "app_image=registry.digitalocean.com/migrationtest" \
            # -var "app_image=${{ secrets.DOCR_REGISTRY }}" \
            -var "db_password=${{ secrets.DB_PASSWORD }}" \
            -var "redis_password=${{ secrets.REDIS_PASSWORD }}" \
            -var "spaces_key=${{ secrets.SPACES_KEY }}" \
            # -var "app_repository=${{ secrets.DOCR_REPOSITORY }}" \
            -var "app_repository=statamic-app" \
            -var "spaces_secret=${{ secrets.SPACES_SECRET }}" | tee terraform.log
      - name: Upload Terraform log
        uses: actions/upload-artifact@v4
        with:
          name: terraform-log
          path: infra/terraform.log

      - name: Get Terraform outputs
        run: |
          cd infra
          terraform output -json > tf_outputs.json

      - name: Set DB envs from Terraform outputs
        id: tf_envs
        run: |
          DB_HOST=$(jq -r .db_host.value infra/tf_outputs.json)
          DB_DATABASE=$(jq -r .db_database.value infra/tf_outputs.json)
          DB_USERNAME=$(jq -r .db_username.value infra/tf_outputs.json)
          DB_PASSWORD=$(jq -r .db_password.value infra/tf_outputs.json)
          echo "DB_HOST=$DB_HOST" >> $GITHUB_ENV
          echo "DB_DATABASE=$DB_DATABASE" >> $GITHUB_ENV
          echo "DB_USERNAME=$DB_USERNAME" >> $GITHUB_ENV
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV

# This file should be generated dynamically in your CI pipeline using values from your .env or GitHub Actions secrets.
# Example generation step in GitHub Actions:
      - name: Generate app.yml
        run: |
          cat <<EOF > app.yml
          name: statamic-app
          services:
            - name: web
              image:
                registry: "${{ secrets.DOCR_REGISTRY }}/statamic-app"
                tag: latest
              http_port: 80
              instance_size_slug: basic-xxs
              instance_count: 1
              envs:
                - key: APP_ENV
                  value: "${{ secrets.APP_ENV }}"
                - key: APP_KEY
                  scope: RUN_AND_BUILD_TIME
                  value: "${{ secrets.APP_KEY }}"
                - key: DB_HOST
                  value: "${{ secrets.DB_HOST }}"
                - key: DB_DATABASE
                  value: "${{ secrets.DB_DATABASE }}"
                - key: DB_USERNAME
                  value: "${{ secrets.DB_USERNAME }}"
                - key: DB_PASSWORD
                  value: "${{ secrets.DB_PASSWORD }}"
          EOF